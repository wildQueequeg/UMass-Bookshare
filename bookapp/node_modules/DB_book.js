var Sequelize = require("sequelize");
var exports = module.exports = {};
var DB_Interface = require("DB_Interface");
var sequelize = DB_Interface.getServer;
var search = null //require("search");

/*
    Define the "model" for the book table.
    This is the structure Sequelize will use when accessing the DB.
*/
var BookTable = exports.booktable = sequelize.define("Book", {
    title: Sequelize.STRING(255),
    author: Sequelize.STRING(60),
    isbn10: Sequelize.STRING(10),
    isbn13: {
        type: Sequelize.STRING(13),
        primaryKey: true
    },
    publicationdate: Sequelize.DATE,
    version: Sequelize.INTEGER,
    cover: Sequelize.BLOB,
    },

    {
    timestamps: false,
    freezeTableName: true,
    tableName: "book"
});
exports.table = BookTable;

/**
* Retrieves a book from the DB based off it's ISBN13 name.
* @param isbn13_
* @param function_ The result of the search will be passed as a parameter to this function. 
* @return JSON like object of the book's values or null if not found
*/
exports.getBookByISBN13 = function getBookbyISBN13(isbn13_, function_) 
{
	var found = BookTable.findOne({
		where: {isbn13: isbn13_}
	});
	found.then(function(record){
		var recordValues = null;
		if(record != null)
		{
			recordValues = {title : record.dataValues.title.trim(),
							author : record.dataValues.author.trim(),
							isbn10 : record.dataValues.isbn10.trim(),
							isbn13 : record.dataValues.isbn13.trim(),
							publicationDate : record.dataValues.publicationDate.trim(),
							version : record.dataValues.version.trim(),
							cover : record.dataValues.cover.trim()}
		}
		else //Need to retrieve from the online DB.
		{
			console.log("Retrieve from online");
		}
		function_(recordValues);
	}

	);
}

/**
* Retrieves a book from the DB based off it's ISBN13 name.
* @param isbn13_
* @param function_ The result of the search will be passed as a parameter to this function. 
* @return JSON like object of the book's values or null if not found
*/
exports.getBookByISBN10 = function getBookbyISBN10(isbn10_, function_) 
{
	var found = BookTable.findOne({
		where: {isbn10: isbn10_}
	});
	found.then(function(record){
		var recordValues = null;
		if(record != null)
		{
			recordValues = {title : record.dataValues.title.trim(),
							author : record.dataValues.author.trim(),
							isbn10 : record.dataValues.isbn10.trim(),
							isbn13 : record.dataValues.isbn13.trim(),
							publicationDate : record.dataValues.publicationDate,
							version : record.dataValues.version,
							cover : record.dataValues.cover}
		}
		else //Need to retrieve from the online DB.
		{
			console.log("Retrieve from online");
		}
		function_(recordValues);
	});
}

/**
* Search for results that partially match the specified fields.
* @param title_ Book title to search for
* @param author_ Book author to search for
* @param version_ Version of the book to search for
* @param function_ The result of the search will be passed as a parameter to this function. 
* @return JSON like object of possible books, the results will need to be refined to get proper ordering.
*/
exports.searchBook = function searchBook(query_, function_)
{
	query_=query_.toUpperCase();
	var bookresult = sequelize.query(
			"SELECT * FROM book WHERE isbn10 = \'" +query_+ "\' OR isbn13 = \'" +query_+ "\' OR UPPER(title) LIKE \'%" +query_+ "%\' OR UPPER(author) LIKE \'%" +query_+ "%\';", BookTable
			 );
	
	bookresult.then(function(record){
		function_(record);
	});
}

exports.searchPost = function searchBook(query_, res_)
{
	query_=query_.toUpperCase();
	var bookresult = sequelize.query(
			"SELECT * FROM book WHERE isbn10 = \'" +query_+ "\' OR isbn13 = \'" +query_+ "\' OR UPPER(title) LIKE \'%" +query_+ "%\' OR UPPER(author) LIKE \'%" +query_+ "%\';", BookTable
			 );
	
	bookresult.then(function(record){
		console.log(record);
		hi = record;
		res_.render('../views/searchResult',hi);
	});
}


/**
* Adds a book to the DB and passes the information to a supplied function. If the isbn13 already exists in the DB no new row will be added.
* @param title_ 
* @param author_
* @param isbn10_
* @param isbn13_
* @param publicationDate_
* @param version_
* @param cover_
* @param function_ The result of the search will be passed as a parameter to this function. 
* @return record[0].options.isNewRecord if you need just a boolean
*/
exports.addBook = function addBook(title_, author_, isbn10_, isbn13_, publicationDate_, version_, cover_, function_)
{
	var found = BookTable.findOrCreate({ where: {isbn13: isbn13_},
		defaults: {
			title: title_,
			author: author_,
			isbn10: isbn10_,
			isbn13: isbn13_,
			publicationdate: publicationDate_,
			version: version_,
			cover: cover_
		}
	});
	found.then(function(record){
		console.log(typeof function_ + "!!");
		function_(record);
	});
}